# 抖音下载器调试指南

## 常见问题与解决方案

### 问题1: 下载的是HTM文件而不是视频

**症状**: 下载完成后，文件是HTML或文本，而不是MP4视频

**原因**: 
- 抖音检测到爬虫行为，返回错误页面
- 从Service Worker发起的请求缺少cookies和会话
- 视频URL已过期或被拦截

**解决方案**: 
✅ 已修复！v1.3使用新的下载流程：
1. Background委托Content Script下载
2. Content Script在页面上下文fetch（有完整cookies）
3. 检查Content-Type确保是视频
4. 转换为Blob后保存

**查看日志**:
```
打开控制台 (F12) → 查找:
📨 委托content script下载视频...
📥 Content script收到下载请求: 文件名.mp4
🔄 在页面上下文中fetch视频...
📄 Content-Type: video/mp4
✅ 视频下载完成，大小: X.XX MB
✅ Blob下载已开始
```

**如果还是失败**:
1. 检查Content-Type，如果是`text/html`说明被拦截
2. 确保抖音标签页是打开的
3. 尝试刷新抖音页面后重试

---

### 问题2: 找不到视频列表（SSR数据为空）

**症状**: 控制台显示 `⚠️ 在SSR数据中未找到视频列表`

**原因**:
- 用户主页结构变化
- 需要登录才能查看
- 页面使用了新的数据格式

**调试步骤**:

1. **查看SSR数据结构**
   ```
   控制台查找: 🔍 SSR数据顶层keys: [...]
   ```
   这会显示数据的顶层字段

2. **查找数据路径**
   ```
   如果找到数据会显示: 📍 数据路径: ["xxx.yyy.aweme_list"]
   ```

3. **手动检查数据**
   ```
   控制台查找: 🔍 尝试手动检查SSR数据结构: {...}
   ```
   这会显示数据的前500个字符

**临时解决方案**:
- 尝试刷新页面
- 确保已登录抖音
- 尝试直接访问用户主页: `https://www.douyin.com/user/[用户ID]`

---

### 问题3: API返回空列表

**症状**: `API返回的aweme_list为空` 或 `API返回空列表，尝试从用户主页获取`

**说明**: 这是正常的，系统会自动切换到备用方案（从用户主页获取）

**查看流程**:
```
API返回空列表，尝试从用户主页获取
  ↓
从RENDER_DATA提取到SSR数据
  ↓
✅ 从用户主页共提取到 X 个视频
```

---

## 调试日志说明

### 正常工作流程

```bash
# 1. 获取视频列表
=== 获取用户视频 ===
用户ID(sec_uid): MS4wLjABAAAA...
请求视频列表: https://www.douyin.com/aweme/v1/web/aweme/post/...
API响应: {...}

# 2. 提取视频URL
✅ 提取视频URL (来源: play_addr): https://v26-web.douyinvod.com/...
提取视频: 【视频标题】

# 3. 下载视频
=== 下载视频 ===
标题: 【视频标题】
作者: 【作者名】
📥 使用fetch下载视频...
Content-Type: video/mp4
✅ 视频下载完成，大小: 5.23 MB
✅ 下载已开始，ID: 1690
```

### 错误流程

```bash
# 方案A失败 → 自动切换方案B
API返回空列表，尝试从用户主页获取
  ↓
尝试从用户主页获取视频: MS4wLjABAAAA...
  ↓
从RENDER_DATA提取到SSR数据
🔍 SSR数据顶层keys: ["app", "user", "location"]
  ↓
⚠️ 在SSR数据中未找到视频列表
❌ 无法从API和主页获取视频
```

---

## 实时监控

### 打开开发者工具
1. 按 `F12` 打开控制台
2. 切换到 "Console" 标签
3. 使用过滤器搜索关键词：
   - `✅` - 成功操作
   - `⚠️` - 警告
   - `❌` - 错误
   - `🔍` - 调试信息

### 重要指标

| 日志 | 含义 | 操作 |
|------|------|------|
| `📦 队列中有 X 个视频待下载` | 队列状态 | 正常，等待下载 |
| `✅ 视频下载完成，大小: X MB` | 下载成功 | 正常 |
| `⚠️ 返回的不是视频内容` | 下载失败 | 检查网络或等待重试 |
| `❌ Fetch失败: 403` | 被拦截 | 抖音检测到爬虫，增加延迟 |

---

## 高级调试

### 查看完整视频对象

如果视频提取失败，控制台会输出：
```
⚠️ 无法获取视频URL: 7472181384652590345
视频对象结构: {"video": {...}}
```

这时可以：
1. 复制这段JSON
2. 使用在线JSON查看器（如 jsonviewer.stack.hu）
3. 查找video字段下的URL列表

### 手动测试视频URL

```javascript
// 在控制台执行
fetch('视频URL', {
  headers: {
    'Referer': 'https://www.douyin.com/',
    'User-Agent': 'Mozilla/5.0...'
  }
}).then(r => console.log('Status:', r.status, 'Type:', r.headers.get('Content-Type')))
```

如果返回：
- `Status: 200, Type: video/mp4` ✅ URL有效
- `Status: 403` ❌ 被拦截，需要更多headers
- `Status: 404` ❌ URL已过期

---

## 报告问题

如果遇到无法解决的问题，请提供：

1. **错误日志**（控制台完整输出）
2. **SSR数据结构**（`🔍 SSR数据顶层keys`的输出）
3. **视频对象结构**（如果有的话）
4. **Chrome版本**和**扩展版本**

---

## 下载流程说明 (v1.3)

### 为什么要在页面上下文下载？

**旧方案（v1.2及以前）**:
- Background Service Worker直接fetch视频URL
- ❌ 问题：Service Worker没有页面cookies
- ❌ 结果：返回403错误或HTML错误页

**新方案（v1.3）**:
```
Background → 委托 → Content Script → Fetch (页面上下文) → Blob → Download
```

优点：
1. ✅ Content Script运行在页面上下文，有完整cookies
2. ✅ 请求看起来像正常的页面行为
3. ✅ 可以检查Content-Type防止下载错误页面
4. ✅ 支持大文件（转为blob后下载）

### 故障排除流程

```bash
下载失败
  ↓
检查控制台日志
  ↓
看到 "委托content script下载" → 正常流程
  ↓
看到 "Content-Type: video/mp4" → 成功！
  ↓
看到 "Content-Type: text/html" → 被拦截
  │
  └→ 解决方案：
     1. 增加延迟（minDelay/maxDelay）
     2. 刷新抖音页面
     3. 检查是否登录
     4. 稍后重试
```

---

**更新日期**: 2025-11-07  
**版本**: v1.3
