# 测试修复 v1.3.2

## 重要修复

**问题**: Blob URL被Chrome下载中断，保存为HTM文件

**解决**: 改用`<a>`标签直接在页面触发下载，避免blob URL生命周期问题

---

## 重新加载扩展

1. 打开 `chrome://extensions/`
2. 找到 "抖音关注视频自动下载器"
3. 点击刷新按钮 🔄
4. 确认显示 "错误" 为0

## 测试步骤

### 1. 打开抖音并登录

访问: https://www.douyin.com/

### 2. 打开控制台

按 `F12` 打开开发者工具

### 3. 触发下载

在popup中点击 "扫描关注列表"

### 4. 观察日志

**成功的日志流程**:
```
✅ 添加视频: [标题]
📦 队列中有 X 个视频待下载
正在下载: [标题] 剩余: X
=== 下载视频 ===
📨 委托content script下载视频...
使用标签页: XXX 抖音 - 记录美好生活

--- 切换到Console标签 (不是Background) ---
📥 Content script收到下载请求: 文件名.mp4
🔄 在页面上下文中fetch视频...
📄 Content-Type: video/mp4
✅ Blob下载完成，大小: 208.XX MB  ← 应该显示完整大小！
📄 Blob类型: video/mp4
💾 创建下载链接...
🖱️ 触发下载...
🧹 清理完成

--- 此时浏览器底部应该出现下载条 ---
```

**关键指标**:
1. ✅ Blob下载完成，大小: **208 MB** (不是几KB)
2. ✅ 浏览器底部出现**真正的下载进度条**
3. ✅ 文件名应该是 `.mp4` 不是 `.htm`

**如果看到这个说明仍被拦截**:
```
❌ HTTP 403: Forbidden
或
📄 Content-Type: text/html
返回的是HTML页面，不是视频
```

## 常见错误

### 错误1: 没有找到抖音标签页

**日志**: `⚠️ 没有找到抖音标签页，使用直接下载`

**解决**: 确保至少有一个抖音标签页是打开的

---

### 错误2: Content-Type: text/html

**日志**: `📄 Content-Type: text/html`

**原因**: 抖音仍然检测到爬虫

**解决**:
1. 增加延迟到40-60秒:
   ```javascript
   // 在background.js修改config
   minDelay: 40000,  // 40秒
   maxDelay: 60000   // 60秒
   ```
2. 刷新抖音页面
3. 等待一段时间后重试

---

### 错误3: 403 Forbidden

**日志**: `❌ HTTP 403: Forbidden`

**原因**: 视频URL可能已过期或需要额外的认证

**解决**:
1. 检查是否已登录抖音
2. 刷新抖音页面后重新触发下载
3. 检查视频URL是否有效（可能被用户删除）

---

## 检查下载的文件

1. 打开下载文件夹中的 `抖音视频` 目录
2. 右键点击下载的文件 → 属性
3. 检查:
   - **文件类型**: 应该是 "MP4 视频" 
   - **大小**: 应该 > 1MB（如果太小如几KB，可能是错误页面）

4. 尝试播放:
   - 如果能播放 → ✅ 成功！
   - 如果不能播放，用记事本打开:
     - 看到 `<!DOCTYPE html>` → ❌ 下载的是HTML
     - 看到乱码二进制 → ✅ 是视频文件，可能播放器问题

---

## 反馈信息

如果仍然失败，请提供：

1. **完整的控制台日志**（从 "=== 下载视频 ===" 开始）
2. **Content-Type值**
3. **下载的文件大小**
4. **Chrome版本**: 在地址栏输入 `chrome://version/`
5. **是否登录抖音**

---

**版本**: v1.3  
**更新**: 2025-11-07
