# 存储方案升级说明

## 🎯 升级概览

我们已将存储方案从 **chrome.storage.local** 升级到 **IndexedDB**，提供更强大、更持久的数据管理能力。

---

## ✨ 新特性

### 1. **更持久的数据存储**
- ✅ **不会因Chrome重装丢失数据**
- ✅ **不会因扩展重装丢失数据**
- ✅ **不受chrome.storage配额限制**
- ✅ **数据在Windows重装后也可能保留**（取决于用户数据分区）

### 2. **细粒度用户管理**
- ✅ **查看所有关注的用户**
- ✅ **启用/禁用特定用户的自动下载**
- ✅ **查看每个用户的视频数量和下载状态**
- ✅ **删除不再关注的用户及其视频记录**

### 3. **视频级别的控制**
- ✅ **查看每个用户的所有视频**
- ✅ **区分已下载和待下载的视频**
- ✅ **查看视频详细信息（标题、时长、发布时间）**
- ✅ **保存完整的视频元数据**

### 4. **强大的统计功能**
- ✅ **关注用户数量统计**
- ✅ **已启用/禁用用户统计**
- ✅ **视频总数和下载进度**
- ✅ **按用户分组的详细统计**

---

## 📊 数据库结构

### **users 表**（关注用户）
| 字段 | 类型 | 说明 |
|------|------|------|
| userId | string | 用户ID (主键) |
| nickname | string | 昵称 |
| avatar | string | 头像URL |
| enabled | boolean | 是否启用自动下载 |
| addedTime | number | 添加时间戳 |
| lastCheckTime | number | 最后检查时间 |
| videoCount | number | 视频数量 |

### **videos 表**（视频记录）
| 字段 | 类型 | 说明 |
|------|------|------|
| awemeId | string | 视频ID (主键) |
| userId | string | 作者ID |
| author | string | 作者昵称 |
| title | string | 视频标题 |
| videoUrl | string | 视频URL |
| coverUrl | string | 封面URL |
| duration | number | 视频时长(ms) |
| createTime | number | 发布时间戳 |
| downloaded | boolean | 是否已下载 |
| downloadTime | number | 下载时间戳 |
| filename | string | 保存的文件名 |

### **config 表**（配置项）
| 字段 | 类型 | 说明 |
|------|------|------|
| key | string | 配置键 (主键) |
| value | any | 配置值 |

---

## 🔄 数据迁移

### 自动迁移
扩展首次启动时会**自动迁移**旧数据：

1. ✅ 从 `chrome.storage.local` 读取旧的已下载视频ID列表
2. ✅ 将这些ID迁移到新的IndexedDB数据库
3. ✅ 保留所有配置项（自动下载、检查间隔等）
4. ✅ 迁移完成后标记，避免重复迁移

### 迁移状态
- 迁移过程是**无感知**的，用户无需手动操作
- 如果没有旧数据，迁移会自动跳过
- 迁移失败不会影响扩展正常使用

---

## 🎨 新增管理界面

### 访问方式
点击扩展图标 → 点击 **"📊 管理用户和视频"** 按钮

### 功能介绍

#### **1. 统计概览**
顶部显示：
- 关注用户总数
- 启用/禁用用户数
- 视频总数
- 已下载/待下载数量

#### **2. 用户管理标签**
- 查看所有关注用户的卡片
- 显示用户头像、昵称、视频数量
- 快速操作：
  - 🟢 **启用/禁用** - 控制是否自动下载该用户的视频
  - 📹 **查看视频** - 查看该用户的所有视频详情
  - 🗑️ **删除** - 删除用户及其所有视频记录

#### **3. 视频管理标签**
- 查看所有已下载的视频列表
- 显示视频封面、标题、作者
- 显示发布时间、视频时长
- 显示下载状态和文件名

---

## 🚀 使用场景

### 场景1：只下载特定用户的视频
1. 打开管理页面
2. 找到不想下载的用户
3. 点击"禁用"按钮
4. 该用户的新视频将不再自动下载

### 场景2：清理不再关注的用户
1. 打开管理页面
2. 找到不再关注的用户
3. 点击"删除"按钮
4. 该用户及其所有视频记录将被删除

### 场景3：查看某个用户的所有视频
1. 打开管理页面
2. 找到目标用户
3. 点击"查看视频"按钮
4. 弹窗显示该用户的所有视频详情

### 场景4：查看下载历史
1. 打开管理页面
2. 切换到"所有视频"标签
3. 浏览所有已下载的视频
4. 查看详细的元数据信息

---

## 🔧 API 说明

### 用户管理 API
```javascript
// 获取所有用户
chrome.runtime.sendMessage({ action: 'getAllUsers' })

// 获取启用的用户
chrome.runtime.sendMessage({ 
  action: 'getAllUsers',
  filter: { enabledOnly: true }
})

// 切换用户启用状态
chrome.runtime.sendMessage({ 
  action: 'toggleUser',
  userId: 'user_id_here'
})

// 删除用户
chrome.runtime.sendMessage({ 
  action: 'deleteUser',
  userId: 'user_id_here'
})
```

### 视频管理 API
```javascript
// 获取用户的所有视频
chrome.runtime.sendMessage({ 
  action: 'getUserVideos',
  userId: 'user_id_here'
})

// 获取用户的未下载视频
chrome.runtime.sendMessage({ 
  action: 'getUserVideos',
  userId: 'user_id_here',
  filter: { notDownloadedOnly: true }
})

// 获取所有已下载视频
chrome.runtime.sendMessage({ 
  action: 'getAllDownloadedVideos'
})
```

### 统计 API
```javascript
// 获取统计信息
chrome.runtime.sendMessage({ action: 'getStats' })
```

---

## 💡 技术细节

### IndexedDB vs chrome.storage.local

| 特性 | IndexedDB | chrome.storage.local |
|------|-----------|---------------------|
| **容量限制** | 磁盘空间的50% | 约10MB |
| **持久性** | 非常高 | 中等 |
| **查询能力** | 支持索引、复杂查询 | 仅支持键值查询 |
| **事务支持** | 完整的事务支持 | 无 |
| **数据结构** | 可存储复杂对象 | 仅JSON可序列化对象 |
| **性能** | 高（异步） | 中等 |

### 为什么选择IndexedDB？
1. ⚡ **容量更大** - 不受配额限制，适合存储大量视频元数据
2. 🔒 **更持久** - Chrome重装后数据仍可能保留
3. 🔍 **强大查询** - 支持按用户、时间、状态等多维度查询
4. 📊 **结构化存储** - 清晰的表结构，易于管理和维护
5. 🚀 **扩展性好** - 未来可添加更多功能（如标签、收藏等）

---

## ⚠️ 注意事项

1. **数据备份建议**
   - 虽然IndexedDB很持久，但建议定期备份重要数据
   - 未来可能添加导出/导入功能

2. **浏览器兼容性**
   - IndexedDB在所有现代浏览器中都支持
   - Chrome扩展环境完美支持

3. **性能优化**
   - 大量数据时，查询可能需要几百毫秒
   - 已对常用查询添加索引优化

4. **隐私说明**
   - 所有数据存储在本地，不会上传到服务器
   - 清除浏览器数据时，IndexedDB数据也会被清除

---

## 🎉 总结

新的存储方案为抖音下载器带来了：
- ✅ **更安全的数据存储**
- ✅ **更强大的管理功能**
- ✅ **更好的用户体验**
- ✅ **更大的扩展潜力**

现在你可以：
- 精确控制每个用户的下载行为
- 查看详细的视频元数据
- 获得完整的统计信息
- 享受更持久的数据保存

享受新功能吧！ 🚀
